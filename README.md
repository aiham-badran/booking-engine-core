# نواة محرّك الحجز – الوثيقة المعمارية

## 1. نظرة عامة

نواة محرّك الحجز (Booking Engine Core) هي نواة منطق أعمال مستقلة عن أي إطار عمل أو قاعدة بيانات، تم تصميمها لمعالجة منطق الحجز بطريقة نظيفة، قابلة للاختبار، وقابلة للتوسّع.

تم بناء النواة وفق مبادئ **Clean Architecture** وبأسلوب عملي من **Domain-Driven Design (DDD)**.

النواة معزولة تمامًا عن:

- أطر العمل (FastAPI، Django، NestJS، وغيرها)
- قواعد البيانات (SQL / NoSQL)
- الـ SDKs والـ APIs
- أي خدمات خارجية

هدفها الأساسي هو أن تكون:

- مستقرة
- قابلة لإعادة الاستخدام
- آمنة عند التطوير والتوسّع

---

## 2. المبادئ التصميمية

### المبادئ الأساسية

- **المسؤولية الواحدة**: كل وحدة لها هدف واضح ومحدد
- **قواعد دومين صريحة**: قواعد العمل موجودة بوضوح داخل Value Objects و Use Cases
- **لا سحر خفي**: لا توجد Base Classes تُخفي منطقًا داخليًا
- **الاختبارات أولًا**: السلوك يُعرّف بالاختبارات
- **عكس الاعتمادية**: النواة تعرّف الواجهات، والطبقات الخارجية تطبّقها

### ما الذي لا تقوم به النواة

- لا تخزين بيانات
- لا مصادقة (Authentication)
- لا صلاحيات (Authorization)
- لا مدفوعات
- لا منطق HTTP أو واجهات مستخدم

---

## 3. البنية المعمارية العامة

```
الطبقات الخارجية (API / SDK / DB / Plugins)
            ↓
طبقة التطبيق (Use Cases)
            ↓
طبقة الدومين (Entities / Value Objects)
```

جميع الاعتمادات تتجه **نحو الداخل فقط**.

---

## 4. هيكل المشروع

```
core/
├── domain/
│   ├── entities/
│   ├── value_objects/
│   ├── enums/
│   └── repositories/
│
├── application/
│   └── use_cases/
│
├── tests/
```

---

## 5. طبقة الدومين (Domain Layer)

### 5.1 الكيانات (Entities)

الكيانات تمثل **مفاهيم أعمال أساسية لها هوية**.

الكيانات المنفذة:

- Organization
- User
- BookingSettings
- Booking

خصائص الكيانات:

- غير قابلة للتغيير (Immutable)
- لا تعتمد على أي إطار عمل
- لا تحتوي أي منطق تخزين

---

### 5.2 كائنات القيم (Value Objects)

كائنات القيم تمثل **مفاهيم دومين مُتحقق منها**.

أمثلة:

- OrganizationId
- UserId
- BookingType
- WorkingDay
- WorkingHours
- TimeSlot

قواعد أساسية:

- التحقق يتم عند الإنشاء
- غير قابلة للتغيير
- لا يوجد وراثة أو Base Class

---

### 5.3 التعدادات (Enums)

تُستخدم Enums فقط لتمثيل **مصطلحات النظام المغلقة**.

الاستخدام الحالي:

- BookingTypeEnum

القاعدة:

- Enum يحدد القيم المسموحة
- Value Object يطبق قواعد الدومين

---

### 5.4 المستودعات (Repositories – Ports)

المستودعات هي **واجهات فقط**.

تحدد كيفية تفاعل النواة مع التخزين دون معرفة أي تفاصيل عن التنفيذ.

أمثلة:

- OrganizationRepository
- UserRepository
- SettingsRepository
- BookingRepository

قواعد:

- لا يوجد BaseRepository
- مستودع واحد لكل Aggregate

---

## 6. طبقة التطبيق (Application Layer – Use Cases)

الـ Use Cases تمثل **أفعال النظام**.

وظيفتها:

- تنسيق الكيانات وكائنات القيم
- تطبيق تسلسل العمل
- استدعاء المستودعات
- عدم احتواء أي منطق تخزين أو إطار عمل

Use Cases المنفذة:

- CreateOrganization / GetOrganization
- CreateUser / GetUser
- UpdateBookingSettings / GetBookingSettings
- CheckAvailability
- CreateBooking / GetBooking

---

## 7. قرار تصميم Availability

تم تنفيذ Availability كـ **Use Case** وليس كـ Domain Service.

الأسباب:

- منطق عديم الحالة (Stateless)
- يمثل سؤالًا وليس مفهوم دومين
- لا يملك هوية
- لا حاجة لإعادة استخدامه داخل الدومين

هذا القرار حافظ على بساطة الدومين ومنع تعقيد غير ضروري.

---

## 8. استراتيجية الاختبارات

- ملف اختبارات لكل Module
- الاختبارات تتحقق من السلوك العام فقط
- لا اختبار للتفاصيل الداخلية
- أي تغيير معماري يتطلب تحديث الاختبارات

النتيجة:

- إعادة هيكلة آمنة
- توثيق حيّ للسلوك

---

## 9. قابلية التوسّع

النواة جاهزة لـ:

- SDKs (Python / JavaScript)
- REST أو GraphQL APIs
- أي قاعدة بيانات
- نظام Plugins

جميع هذه التوسعات تتم **خارج النواة** دون تعديلها.

---

## 10. الخطوات القادمة

الترتيب الموصى به:

1. تصميم SDK
2. بناء API
3. نظام Plugins
4. تنفيذ التخزين (Persistence)

يجب أن تبقى النواة دون تغيير خلال هذه المراحل.

---

## 11. ملاحظات ختامية

تم تصميم هذه النواة لتكون:

- سهلة القراءة
- سهلة الاختبار
- آمنة للتوسعة

أي ميزة تتطلب تعديل النواة بشكل متكرر، غالبًا **لا تنتمي للنواة**.

---

**نواة محرّك الحجز – الإصدار الأول (v1)**
